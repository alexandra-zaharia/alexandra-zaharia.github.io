<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Concurrency crash course. Part 2: Threads and the Python GIL" /><meta name="author" content="Alexandra Zaharia" /><meta property="og:locale" content="en" /><meta name="description" content="This is a multi-part post: Part 1 establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges faced in concurrent programming. Part 2 (this article) shows what can go wrong when using threads without synchronization and explains the role and effects of the Global Interpreter Lock (GIL) in Python. Part 3 (TODO) explains some common thread synchronization primitives, accompanied by Python examples. Part 4 (TODO) explains some common process synchronization primitives (inter-process communication mechanisms), accompanied by Python examples. Part 5 (TODO) tackles parallel algorithm design and performance evaluation." /><meta property="og:description" content="This is a multi-part post: Part 1 establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges faced in concurrent programming. Part 2 (this article) shows what can go wrong when using threads without synchronization and explains the role and effects of the Global Interpreter Lock (GIL) in Python. Part 3 (TODO) explains some common thread synchronization primitives, accompanied by Python examples. Part 4 (TODO) explains some common process synchronization primitives (inter-process communication mechanisms), accompanied by Python examples. Part 5 (TODO) tackles parallel algorithm design and performance evaluation." /><link rel="canonical" href="https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" /><meta property="og:url" content="https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" /><meta property="og:site_name" content="Alexandra Zaharia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-09T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Concurrency crash course. Part 2: Threads and the Python GIL" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Alexandra Zaharia" /><meta name="google-site-verification" content="mlwABpnF22MCyeNCQoei9VdIPvqy_uV7b4v_vArTxXM" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexandra Zaharia"},"dateModified":"2022-01-09T00:00:00+01:00","datePublished":"2022-01-09T00:00:00+01:00","description":"This is a multi-part post: Part 1 establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges faced in concurrent programming. Part 2 (this article) shows what can go wrong when using threads without synchronization and explains the role and effects of the Global Interpreter Lock (GIL) in Python. Part 3 (TODO) explains some common thread synchronization primitives, accompanied by Python examples. Part 4 (TODO) explains some common process synchronization primitives (inter-process communication mechanisms), accompanied by Python examples. Part 5 (TODO) tackles parallel algorithm design and performance evaluation.","headline":"Concurrency crash course. Part 2: Threads and the Python GIL","mainEntityOfPage":{"@type":"WebPage","@id":"https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/"},"url":"https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/"}</script><title>Concurrency crash course. Part 2&#58; Threads and the Python GIL | Alexandra Zaharia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Alexandra Zaharia"><meta name="application-name" content="Alexandra Zaharia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/site/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Alexandra Zaharia</a></div><div class="site-subtitle font-italic">My dev blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-user ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/alexandra-zaharia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/alexandra-zaharia-fr" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['contact','alexandra-zaharia.org'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Concurrency crash course. Part 2&#58; Threads and the Python GIL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Concurrency crash course. Part 2&#58; Threads and the Python GIL</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Alexandra Zaharia </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 9, 2022, 12:00 AM +0100" >Jan 9, 2022<i class="unloaded">2022-01-09T00:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1754 words">9 min read</span></div></div><div class="post-content"><p>This is a multi-part post:</p><ul><li><a href="/posts/concurrency-crash-course-part-1/">Part 1</a> establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges faced in concurrent programming.<li>Part 2 (this article) shows what can go wrong when using threads without synchronization and explains the role and effects of the Global Interpreter Lock (GIL) in Python.<li>Part 3 (TODO) explains some common thread synchronization primitives, accompanied by Python examples.<li>Part 4 (TODO) explains some common process synchronization primitives (inter-process communication mechanisms), accompanied by Python examples.<li>Part 5 (TODO) tackles parallel algorithm design and performance evaluation.</ul><h2 id="threads">Threads</h2><p>Remember from our <a href="/posts/concurrency-crash-course-part-1/">last</a> post that threads are the smallest set of instructions that can be managed by the scheduler. Unlike processes, multiple threads of a program share the same <strong>address space</strong> and are capable of accessing the same <strong>data</strong>.</p><p>Each thread has its own program counter and registers. The program counter is a special register that tracks the instruction that is currently being executed (or the next instruction to be executed). When the scheduler switches between two threads running on a single CPU, a <strong>context switch</strong> takes place in which the state of the registers of the thread being <em>switched from</em> are stored and the registers of the thread being <em>switched to</em> are restored.</p><p>Here’s an inspirational quote from <a href="https://pages.cs.wisc.edu/~remzi/OSTEP/">OSTEP</a> (Remzi H. Arpaci-Dusseau and Andrea C. Arpaci-Dusseau, chapter 26, <em>Concurrency and threads</em>) to get us started:</p><blockquote><p>Computers are hard enough to understand without concurrency. Unfortunately, with concurrency, it simply gets worse. Much worse.</p></blockquote><p>In Python, we can create and manage threads using the <a href="https://docs.python.org/3/library/threading.html"><code class="language-plaintext highlighter-rouge">threading</code></a> module. In the following example we create and start two threads that run the method <code class="language-plaintext highlighter-rouge">my_task()</code> (which essentially does nothing of interest beside sleep for a given amount of time):</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">time</span>


<span class="k">def</span> <span class="nf">my_task</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{} got x={}, y={}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="nf">current_thread</span><span class="p">().</span><span class="nf">getName</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{} finished after {:.2f} seconds</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
        <span class="n">threading</span><span class="p">.</span><span class="nf">current_thread</span><span class="p">().</span><span class="nf">getName</span><span class="p">(),</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">thr1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">my_task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">Thread 1</span><span class="sh">'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,))</span>
    <span class="n">thr2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">my_task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">Thread 2</span><span class="sh">'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(.</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="mi">2</span><span class="p">,))</span>

    <span class="n">thr1</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">thr2</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">thr1</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
    <span class="n">thr2</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Main thread finished</span><span class="sh">'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></table></code></div></div><p>In <code class="language-plaintext highlighter-rouge">main()</code>, we create the threads, then actually <code class="language-plaintext highlighter-rouge">start()</code> them, and finally <code class="language-plaintext highlighter-rouge">join()</code> them. <em>Joining</em> a thread means to wait until it terminates. Unsurprisingly, here is the output of the above program:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Thread 1 got x=1, y=2
Thread 2 got x=0.1, y=0.2
Thread 2 finished after 0.30 seconds
Thread 1 finished after 3.00 seconds
Main thread finished
</pre></table></code></div></div><h2 id="why-do-we-need-synchronization">Why do we need synchronization?</h2><p><em>But everything works fine. Why do we need synchronization?</em> Glad you’ve asked! Concurrency can be tricky. Remember that we have discussed some common concurrency pitfalls in <a href="/posts/concurrency-crash-course-part-1/">Part 1</a> of this series. It might have all seemed a bit abstract, so let us now look at an example where things don’t go according to plan. Suppose we have two threads and each one increments a global counter:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">threading</span>


<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">counter</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">thr1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increment</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">500000</span><span class="p">,))</span>
    <span class="n">thr2</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increment</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">500000</span><span class="p">,))</span>

    <span class="n">thr1</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">thr2</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">thr1</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
    <span class="n">thr2</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">counter = </span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</pre></table></code></div></div><p>The result is not what we expect. Even worse, it is inconsistent from run to run:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>$ python 02_b_sum_without_synchronization.py
counter = 793916
$ python 02_b_sum_without_synchronization.py
counter = 1000000
$ python 02_b_sum_without_synchronization.py
counter = 697999
$ python 02_b_sum_without_synchronization.py
counter = 872864
</pre></table></code></div></div><p>Let us understand what just happened:</p><p><img data-proofer-ignore data-src="/assets/img/posts/thread_sync.png" alt="Thread synchronization" width="700" /></p><h3 id="critical-section">Critical section</h3><p>A <strong>critical section</strong> refers to code that can result in a race condition when executed by multiple threads, because a a shared resource is involved.</p><p>In our example, both threads attempt to modify the global <code class="language-plaintext highlighter-rouge">counter</code> variable by incrementing it. In other words, both threads access a shared resource in a critical section in write mode, without using thread synchronization.</p><h3 id="race-condition">Race condition</h3><p>A <strong>race condition</strong> occurs when several threads execute a critical section without synchronization mechanisms in place. Depending on the order in which the threads execute the critical section, the result of the program is different.</p><p>In our example, both threads attempt to increment the global counter; as we’ve seen, not all increments are successful.</p><h3 id="atomic-operations">Atomic operations</h3><p>A series of actions is <strong>atomic</strong> if the actions are “all or nothing”, meaning they either <em>all</em> occur, or <em>none</em> occur. (You might be familiar with database <em>transactions</em>: by definition, they are atomic.)</p><p>In our example, increments do not succeed because the increment operation itself is not atomic. Suppose the <code class="language-plaintext highlighter-rouge">counter</code> contains the value 3. In order to increment it, the first step is to read its current value (3) into a temporary location. The second step is to increment this temporary value (it now becomes 4). The final step is to copy the new value from the temporary location (4) into the counter. However, if a second thread accesses the counter concurrently, it can change its value while the “lagging” thread uses the stale value from the temporary location.</p><p>This problem can be solved by rendering critical sections atomic through thread synchronization primitives such as <em>locks</em> or <em>semaphores</em>. What we mean by that is that we allow one thread to execute the critical section while the others are denied access to the critical section until the thread that is in control releases it. We will look into thread synchronization primitives in detail in the next post.</p><h2 id="thread-communication">Thread communication</h2><p>Apart from thread synchronization, concurrency can also involve thread communication. While thread synchronization and thread communication are related, in thread communication the focus is shifted to threads <em>waiting</em> on other threads to finish before executing. In the next part of this series we will see how <strong>condition variables</strong> help us achieve thread communication.</p><h2 id="the-global-interpreter-lock-gil-in-python">The Global Interpreter Lock (GIL) in Python</h2><p>Now that we’ve seen why thread synchronization is necessary, we cannot simply jump right in without first mentioning the dreaded Python GIL, short for the <a href="https://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock</a>.</p><h3 id="python-interpreters">Python interpreters</h3><p>Before properly defining the GIL, we need to take a step back and talk about… Python. In the strictest sense, Python is “just” a programming language <em>specification</em>. Python <em>interpreters</em> are different implementations of the Python language specification. The most popular implementation is CPython (written in C), commonly called <code class="language-plaintext highlighter-rouge">python</code> by language abuse. Alternative Python implementations <a href="https://www.python.org/download/alternatives/">exist</a>.</p><p>The image below summarizes the relationship between language <em>specification</em> and <em>implementation</em>:</p><p><img data-proofer-ignore data-src="/assets/img/posts/python_implementations.png" alt="Specification vs implementations" width="700" /></p><h3 id="cpython-and-the-gil">CPython and the GIL</h3><p>When we run a Python script using the <code class="language-plaintext highlighter-rouge">python</code> (i.e. CPython) interpreter, the source code is first <em>compiled</em> into byte code, a low-level platform-independent representation that is executed by the Python virtual machine. You have probably already seen the <code class="language-plaintext highlighter-rouge">.pyc</code> files in the <code class="language-plaintext highlighter-rouge">__pycache__</code> directory – that is byte code. The Python virtual machine is not a separate component, but rather a loop running inside the Python interpreter. It simply executes the generated byte code line by line.</p><p>The GIL is a mechanism that limits Python (remember we’re talking about the CPython interpreter) to execute only one thread at a time. Below you can see a <a href="http://dabeaz.com/GIL/gilvis/">GIL visualisation</a> showing the main thread and 4 additional threads running on a single CPU; the green blocks represent the time when threads are executing:</p><p><img data-proofer-ignore data-src="/assets/img/posts/conc_4thr_1cpu.png" alt="Four threads running on 1 CPU" width="700" /></p><h3 id="the-reason-behind-the-gil">The reason behind the GIL</h3><p>Why would Python designers restrict the CPython interpreter to only be able to execute a single thread at a time? When CPython was being developed, its <a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">garbage collector</a> was designed to use reference counting. This means that an object is released from memory when its reference count reaches zero.</p><p>We can get the reference count of an object in memory using <code class="language-plaintext highlighter-rouge">sys.getrefcount()</code>. In the example below, notice that when we assign the object to a new variable, the reference count increases:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="kn">import</span> <span class="n">sys</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">z</span> <span class="o">=</span> <span class="sh">"</span><span class="s">this is a string variable</span><span class="sh">"</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="n">sys</span><span class="p">.</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="mi">8</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">sys</span><span class="p">.</span><span class="nf">getrefcount</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="mi">9</span>
</pre></table></code></div></div><p>If several threads are running, race conditions may modify the reference count if it is not protected by a simple synchronization mechanism called “lock” (that we will be looking into in the next post). The solution was to impose a global lock providing exclusive access to the Python interpreter. This way, the Python interpreter executes byte code using the GIL, which in turn means that only one thread is active at any given time. The advantage is that reference counting becomes thread-safe. The drawback is that the remaining threads from the byte code must wait for the GIL to become available.</p><p>You can also check out the article over at <a href="https://realpython.com/python-gil/">RealPython</a> for more context.</p><h3 id="effects-of-the-gil">Effects of the GIL</h3><p>The dreaded effect of the Python GIL that we’ve hinted at earlier is that, no matter how many CPUs there are, since only a single thread can run at a time, the extra CPU cores remain unused. In other words, I/O-bound problems can be sped up through multithreading, albeit the threads run one at a time, in interleaved fashion. However, because the GIL prevents threads from running in parallel, no speed-up is possible unfortunately for CPU-bound problems (which, as we’ve seen in <a href="/posts/concurrency-crash-course-part-1/">Part 1</a>, require parallel execution).</p><p>Do not despair though: multiple CPUs <em>can</em> be used in Python if we create <em>processes</em> instead of threads. Since every process comes with its own interpreter, the GIL issue is effectively side-stepped. We will be looking into processes in a later article in this series.</p><h2 id="conclusion">Conclusion</h2><p>In this post we’ve seen:</p><ul><li>How to launch separate threads in Python<li>That launching threads without synchronizing them is rarely a good idea. We need to:<ul><li>control how threads access a critical section<li>have threads wait on other threads to finish</ul><li>How the Python GIL (Global Interpreter Lock) complicates things further by only allowing a single thread to be active at a time</ul><p>The next post in this series will present thread synchronization primitives and show how they can be used in Python. In subsequent posts we will also be discussing processes, asynchronous programming, as well as parallel algorithm design and evaluation.</p><h2 id="resources">Resources</h2><ul><li><a href="https://docs.python.org/3/library/threading.html"><code class="language-plaintext highlighter-rouge">threading</code></a> (Python documentation)<li><a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">Garbage collection</a> (Wikipedia)<li><a href="http://dabeaz.com/GIL/gilvis/">Python GIL visualizations</a> (David Beazley)<li><a href="https://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock</a> (Python wiki)<li><a href="https://realpython.com/python-gil/">Global Interpreter Lock</a> (Abhinav Ajitsaria @ RealPython, 2018)<li><a href="https://pages.cs.wisc.edu/~remzi/OSTEP/">Operating systems: Three easy pieces</a> (Arpaci-Dusseau &amp; Arpaci-Dusseau)<li><a href="https://www.educative.io/courses/python-concurrency-for-senior-engineering-interviews/">Python concurrency for senior engineering interviews</a> (educative.io course)</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/computer-science/'>Computer science</a>, <a href='/categories/concurrency/'>concurrency</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/thread/" class="post-tag no-text-decoration" >thread</a> <a href="/tags/process/" class="post-tag no-text-decoration" >process</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Concurrency crash course. Part 2&#58; Threads and the Python GIL - Alexandra Zaharia&url=https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Concurrency crash course. Part 2&#58; Threads and the Python GIL - Alexandra Zaharia&u=https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Concurrency crash course. Part 2&#58; Threads and the Python GIL - Alexandra Zaharia&url=https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=Concurrency crash course. Part 2&#58; Threads and the Python GIL - Alexandra Zaharia&u=https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw fab fa-hacker-news"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/connect-bluetooth-headset-automatically-linux/">Connect a bluetooth headset automatically in Linux</a><li><a href="/posts/concurrency-crash-course-part-1/">Concurrency crash course. Part 1&#58; Terminology, usage and pitfalls</a><li><a href="/posts/my-2021-dev-retrospective/">My 2021 dev retrospective</a><li><a href="/posts/how-to-stop-a-python-thread-cleanly/">How to stop a Python thread cleanly</a><li><a href="/posts/how-to-return-a-result-from-a-python-thread/">How to return a result from a Python thread</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c-c/">c/c++</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/binary/">binary</a> <a class="post-tag" href="/tags/bluetooth/">bluetooth</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/mercurial/">mercurial</a> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/version-control/">version control</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/concurrency-crash-course-part-1/"><div class="card-body"> <span class="timeago small" >Dec 30, 2021<i class="unloaded">2021-12-30T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Concurrency crash course. Part 1&#58; Terminology, usage and pitfalls</h3><div class="text-muted small"><p> This is a multi-part post: Part 1 (this article) establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges fac...</p></div></div></a></div><div class="card"> <a href="/posts/kill-subprocess-and-its-children-on-timeout-python/"><div class="card-body"> <span class="timeago small" >Jul 5, 2021<i class="unloaded">2021-07-05T01:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kill a Python subprocess and its children when a timeout is reached</h3><div class="text-muted small"><p> Suppose a Python script needs to launch an external command. This can be done using the subprocess module in one of two ways: either use the “convenience” function subprocess.run() or use the...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-return-a-result-from-a-python-thread/"><div class="card-body"> <span class="timeago small" >Aug 24, 2021<i class="unloaded">2021-08-24T01:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to return a result from a Python thread</h3><div class="text-muted small"><p> The problem Suppose you have a Python thread that runs your target function. Simple scenario: That target function returns a result that you want to retrieve. A more advanced scenario: You w...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/my-2022-dev-resolutions/" class="btn btn-outline-primary" prompt="Older"><p>My 2022 dev resolutions</p></a> <a href="/posts/resize-and-compress-pdf/" class="btn btn-outline-primary" prompt="Newer"><p>Resize and compress a PDF in Linux</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://alexandra-zaharia.github.io/posts/concurrency-crash-course-part-2/'; this.page.identifier = '/posts/concurrency-crash-course-part-2/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://azc.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/alexandra-zaharia">Alexandra Zaharia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c-c/">c/c++</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/binary/">binary</a> <a class="post-tag" href="/tags/bluetooth/">bluetooth</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/mercurial/">mercurial</a> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/version-control/">version control</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Z7ZY7JRFQJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Z7ZY7JRFQJ'); }); </script>
