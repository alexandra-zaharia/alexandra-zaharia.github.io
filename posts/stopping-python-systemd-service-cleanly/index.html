<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Stopping a Python systemd service cleanly" /><meta name="author" content="Alexandra Zaharia" /><meta property="og:locale" content="en" /><meta name="description" content="Suppose you are running a Python systemd service that opens some file descriptors (these can be regular files, named pipes, sockets, and so on). When the service is stopped, it needs to finish cleanly by closing and/or removing the associated resources. This post presents two manners in which the service may be stopped gracefully." /><meta property="og:description" content="Suppose you are running a Python systemd service that opens some file descriptors (these can be regular files, named pipes, sockets, and so on). When the service is stopped, it needs to finish cleanly by closing and/or removing the associated resources. This post presents two manners in which the service may be stopped gracefully." /><link rel="canonical" href="https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" /><meta property="og:url" content="https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" /><meta property="og:site_name" content="Alexandra Zaharia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-26T01:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Stopping a Python systemd service cleanly" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Alexandra Zaharia" /><meta name="google-site-verification" content="mlwABpnF22MCyeNCQoei9VdIPvqy_uV7b4v_vArTxXM" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexandra Zaharia"},"dateModified":"2021-06-26T01:00:00+02:00","datePublished":"2021-06-26T01:00:00+02:00","description":"Suppose you are running a Python systemd service that opens some file descriptors (these can be regular files, named pipes, sockets, and so on). When the service is stopped, it needs to finish cleanly by closing and/or removing the associated resources. This post presents two manners in which the service may be stopped gracefully.","headline":"Stopping a Python systemd service cleanly","mainEntityOfPage":{"@type":"WebPage","@id":"https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/"},"url":"https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/"}</script><title>Stopping a Python systemd service cleanly | Alexandra Zaharia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Alexandra Zaharia"><meta name="application-name" content="Alexandra Zaharia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/site/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">Alexandra Zaharia</a>
</div>
<div class="site-subtitle font-italic">My dev blog</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a>
</li>
<li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-user ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/alexandra-zaharia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/alexandra-zaharia-fr" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['contact','alexandra-zaharia.org'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div>
</div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Stopping a Python systemd service cleanly</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper">
<div id="main">
<div class="row">
<div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<h1 data-toc-skip>Stopping a Python systemd service cleanly</h1>
<div class="post-meta text-muted d-flex flex-column">
<div> <span class="semi-bold"> Alexandra Zaharia </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 26, 2021, 1:00 AM +0200">Jun 26, 2021<i class="unloaded">2021-06-26T01:00:00+02:00</i> </span>
</div>
<div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1202 words">6 min read</span>
</div>
</div>
<div class="post-content">
<p>Suppose you are running a Python systemd service that opens some file descriptors (these can be regular files, named pipes, sockets, and so on). When the service is stopped, it needs to finish cleanly by closing and/or removing the associated resources. This post presents two manners in which the service may be stopped gracefully.</p>
<p>First, we will look at how a Python script <code class="language-plaintext highlighter-rouge">my_service.py</code> may be ran as a systemd service. Next, we will discuss the general form of that Python script. Finally, we will see how to stop the service gracefully.</p>
<h2 id="running-a-python-script-as-a-systemd-service">Running a Python script as a systemd service</h2>
<p>An executable can be made into a systemd service by creating a <em>unit (configuration) file</em>, also known as a <code class="language-plaintext highlighter-rouge">.service</code> file (see the <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service</a> man page). The <code class="language-plaintext highlighter-rouge">.service</code> files are stored in a specific location and have a certain format.</p>
<h3 id="unit-file-location">Unit file location</h3>
<p>There are actually three places where <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">unit files</a> may be stored:</p>
<ul>
<li>
<code class="language-plaintext highlighter-rouge">/etc/systemd/system/</code>: system-specific; take precedence over run-time unit files</li>
<li>
<code class="language-plaintext highlighter-rouge">/run/systemd/system/</code>: run-time; take precedence over default unit files</li>
<li>
<code class="language-plaintext highlighter-rouge">/usr/lib/systemd/system/</code>: default; may be overwritten when the system updates</li>
</ul>
<p>If you create your own systemd service, place the <code class="language-plaintext highlighter-rouge">.service</code> unit file in <code class="language-plaintext highlighter-rouge">/etc/systemd/system/</code>.</p>
<h3 id="unit-file-format">Unit file format</h3>
<p>A unit file (for a service) has three sections: <code class="language-plaintext highlighter-rouge">[Unit]</code>, <code class="language-plaintext highlighter-rouge">[Service]</code> and <code class="language-plaintext highlighter-rouge">[Install]</code>. You can read more on <a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files">unit file anatomy</a>. For this example, let us assume a very simple <code class="language-plaintext highlighter-rouge">my-service.service</code> file:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="rouge-code"><pre>[Unit]
Description=My test service
After=network.target

[Service]
User=alex
Type=simple
ExecStart=/usr/bin/python /home/alex/services/my_service.py

[Install]
WantedBy=multi-user.target
</pre></td>
</tr></tbody></table></code></div>
</div>
<h3 id="using-the-service">Using the service</h3>
<p>First, we need to add the new service and to reload systemd:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nb">sudo ln</span> <span class="nt">-sf</span> ~/services/my-service.service /etc/systemd/system/my-service.service
<span class="nb">sudo </span>systemctl daemon-reload
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Then we can enable the service (this way it will be ran each time the system boots) and start it:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nb">sudo </span>systemctl <span class="nb">enable </span>my-service.service
<span class="nb">sudo </span>systemctl start my-service.service
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>If <code class="language-plaintext highlighter-rouge">my_service.py</code> is configured to log information (and it should!), we can check the system logs with <code class="language-plaintext highlighter-rouge">journalctl</code>:</p>
<div class="language-bash highlighter-rouge">
<div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>journalctl <span class="nt">-u</span> my-service.service
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Add an <code class="language-plaintext highlighter-rouge">-f</code> to the previous command if you want to follow the journal as it updates, just like with <code class="language-plaintext highlighter-rouge">tail -f</code>.</p>
<h3 id="the-danger-zone">The danger zone</h3>
<p>Recall the original assumption: <code class="language-plaintext highlighter-rouge">my_service.py</code> opens file descriptors and uses the underlying resources. Whenever the service stops running (through <code class="language-plaintext highlighter-rouge">sudo systemctl stop my-service.service</code>, for example), it must do so gracefully by closing the open resources first.</p>
<p>Before diving into the possible solutions, let us first take a look at the general structure of the <code class="language-plaintext highlighter-rouge">my_service.py</code> script.</p>
<h2 id="the-structure-of-the-python-service">The structure of the Python service</h2>
<p>The Python service (<code class="language-plaintext highlighter-rouge">my_service.py</code>) may be a TCP server, client, or any other process that needs to run as a daemon. For the purpose of this example, let us suppose that the service uses a standard event loop and opens a named pipe in <code class="language-plaintext highlighter-rouge">/tmp</code> to read from it. Instead of doing something useful, our example service will just sleep and then log something when it wakes up. The general structure is as follows (possible exceptions from the <code class="language-plaintext highlighter-rouge">os</code> module are not caught for brevity purposes):</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td>
<td class="rouge-code"><pre><span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">time</span>


<span class="k">class</span> <span class="nc">MyService</span><span class="p">:</span>
    <span class="n">FIFO</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/tmp/myservice_pipe</span><span class="sh">'</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_init_logger</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">MyService</span><span class="p">.</span><span class="n">FIFO</span><span class="p">):</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">mkfifo</span><span class="p">(</span><span class="n">MyService</span><span class="p">.</span><span class="n">FIFO</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">MyService</span><span class="p">.</span><span class="n">FIFO</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">MyService instance created</span><span class="sh">'</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_init_logger</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">stdout_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nc">StreamHandler</span><span class="p">()</span>
        <span class="n">stdout_handler</span><span class="p">.</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">stdout_handler</span><span class="p">.</span><span class="nf">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="nc">Formatter</span><span class="p">(</span><span class="sh">'</span><span class="s">%(levelname)8s | %(message)s</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">addHandler</span><span class="p">(</span><span class="n">stdout_handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">delay</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Tick</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">Keyboard interrupt (SIGINT) received...</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Cleaning up...</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">MyService</span><span class="p">.</span><span class="n">FIFO</span><span class="p">):</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fifo</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">MyService</span><span class="p">.</span><span class="n">FIFO</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Named pipe removed</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Named pipe not found, nothing to clean up</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">service</span> <span class="o">=</span> <span class="nc">MyService</span><span class="p">()</span>
    <span class="n">service</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>If <code class="language-plaintext highlighter-rouge">my_service.py</code> is ran in a terminal, we can stop it by hitting Ctrl+C (registered as SIGINT):</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre>python test_service.py 
    INFO | MyService instance created
    INFO | Tick
    INFO | Tick
^C WARNING | Keyboard interrupt (SIGINT) received...
    INFO | Cleaning up...
    INFO | Named pipe removed
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="how-to-stop-the-python-service-gracefully">How to stop the Python service gracefully</h2>
<p>In the previous section we’ve seen that the named pipe is removed as expected if <code class="language-plaintext highlighter-rouge">my_service.py</code> is executed in a console. However, if we run it as a systemd service, stopping it via <code class="language-plaintext highlighter-rouge">systemctl</code> will result in an improper shutdown of our service: the named pipe is not removed <img class="emoji" title=":scream:" alt=":scream:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f631.png" height="20" width="20"></p>
<p>This happens because, by default, the kill signal sent by systemd when using <code class="language-plaintext highlighter-rouge">systemctl stop</code> is SIGTERM, not SIGINT, therefore we cannot catch it as a <code class="language-plaintext highlighter-rouge">KeyboardInterrupt</code>.</p>
<p>Here are two solutions for this problem.</p>
<h3 id="use-sigint-instead-of-sigterm">Use SIGINT instead of SIGTERM</h3>
<p>The most immediate solution is to instruct systemd to send a SIGINT (registered as a keyboard interrupt) instead of the default SIGTERM. This is done by adding the following line to the <code class="language-plaintext highlighter-rouge">[Service]</code> section of the <code class="language-plaintext highlighter-rouge">my-service.service</code> unit file:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>KillSignal=SIGINT
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>This way, whenever we stop or restart the service with <code class="language-plaintext highlighter-rouge">systemctl</code>, the signal sent to kill <code class="language-plaintext highlighter-rouge">my_service.py</code> is SIGINT and it is caught by the <code class="language-plaintext highlighter-rouge">except</code> block in lines 32-34.</p>
<h3 id="use-a-sigterm-handler">Use a SIGTERM handler</h3>
<p>The other solution is to register a signal handler for SIGTERM. For this, we will need to <code class="language-plaintext highlighter-rouge">import signal</code> and instruct Python to do something useful when receiving a SIGTERM. We add the following method to the <code class="language-plaintext highlighter-rouge">MyService</code> class:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">_handle_sigterm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sh">'</span><span class="s">SIGTERM received...</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>Note the two arguments <code class="language-plaintext highlighter-rouge">sig</code> and <code class="language-plaintext highlighter-rouge">frame</code>: although not used explicitly, they must be present because this is the method that we will register for handling SIGTERM. If they are absent we get a <code class="language-plaintext highlighter-rouge">TypeError</code> when a SIGTERM is received. We add the following line to the <code class="language-plaintext highlighter-rouge">__init__()</code> method:</p>
<div class="language-python highlighter-rouge">
<div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre>        <span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_handle_sigterm</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>If we check the system log with <code class="language-plaintext highlighter-rouge">journalctl -u my-service.service</code> we see the following:</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre>juin 26 18:35:17 phantom systemd[1]: Started My test service.
juin 26 18:35:17 phantom python[558725]:     INFO | MyService instance created
juin 26 18:35:22 phantom python[558725]:     INFO | Tick
juin 26 18:35:27 phantom python[558725]:     INFO | Tick
juin 26 18:35:32 phantom python[558725]:  WARNING | SIGTERM received...
juin 26 18:35:32 phantom python[558725]:     INFO | Cleaning up...
juin 26 18:35:32 phantom python[558725]:     INFO | Named pipe removed
juin 26 18:35:32 phantom systemd[1]: Stopping My test service...
juin 26 18:35:32 phantom systemd[1]: test-service.service: Succeeded.
juin 26 18:35:32 phantom systemd[1]: Stopped My test service.
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>That’s it! You can now use either of the two methods to stop your Python systemd service gracefully: either tell systemd to kill it with a SIGINT or, better yet, install a custom SIGTERM handler.</p>
<p>There’s a caveat with both approaches if the service launches more than one process. The <a href="https://www.freedesktop.org/software/systemd/man/systemd.kill.html">systemd.kill</a> man page explains that by default (when <code class="language-plaintext highlighter-rouge">KillMode=control-group</code>) all the processes launched by the unit file will receive SIGTERM (or SIGINT if we use <code class="language-plaintext highlighter-rouge">KillSignal=SIGINT</code> as explained here). However, if they fail to stop, they will be knocked-out with SIGKILL. In such situations, one should be extra-careful with proper shutdown and cleanup.</p>
<h2 id="further-reading">Further reading</h2>
<ul>
<li><a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service man page</a></li>
<li><a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">systemd.unit man page</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files">Anatomy of a systemd unit file</a></li>
<li><a href="https://www.freedesktop.org/software/systemd/man/systemd.kill.html">systemd.kill man page</a></li>
</ul>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/python/">Python</a>, <a href="/categories/systemd/">systemd</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration">python</a> <a href="/tags/systemd/" class="post-tag no-text-decoration">systemd</a> <a href="/tags/service/" class="post-tag no-text-decoration">service</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Stopping%20a%20Python%20systemd%20service%20cleanly%20-%20Alexandra%20Zaharia&amp;url=https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Stopping%20a%20Python%20systemd%20service%20cleanly%20-%20Alexandra%20Zaharia&amp;u=https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Stopping%20a%20Python%20systemd%20service%20cleanly%20-%20Alexandra%20Zaharia&amp;url=https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=Stopping%20a%20Python%20systemd%20service%20cleanly%20-%20Alexandra%20Zaharia&amp;u=https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw fab fa-hacker-news"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">
<div class="access">
<div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/connect-bluetooth-headset-automatically-linux/">Connect a bluetooth headset automatically in Linux</a></li>
<li><a href="/posts/concurrency-crash-course-part-1/">Concurrency crash course. Part 1: Terminology, usage and pitfalls</a></li>
<li><a href="/posts/my-2021-dev-retrospective/">My 2021 dev retrospective</a></li>
<li><a href="/posts/how-to-stop-a-python-thread-cleanly/">How to stop a Python thread cleanly</a></li>
<li><a href="/posts/how-to-return-a-result-from-a-python-thread/">How to return a result from a Python thread</a></li>
</ul>
</div>
<div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c-c/">c/c++</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/binary/">binary</a> <a class="post-tag" href="/tags/bluetooth/">bluetooth</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/mercurial/">mercurial</a> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/version-control/">version control</a>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav>
</div>
</div>
</div>
<div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/concurrency-crash-course-part-2/"><div class="card-body"> <span class="timeago small">Jan 9, 2022<i class="unloaded">2022-01-09T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Concurrency crash course. Part 2: Threads and the Python GIL</h3>
<div class="text-muted small"><p> This is a multi-part post: Part 1 establishes terminology (tasks, threads and processes and how they relate to concurrency and parallelism) and gives an overview of challenges faced in concurren...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/function-timeout-in-python-signal/"><div class="card-body"> <span class="timeago small">Feb 5, 2016<i class="unloaded">2016-02-05T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Function timeout in Python using the signal module</h3>
<div class="text-muted small"><p> The problem Sometimes you may want to impose a timeout on a Python function. Why would you want to do such a thing? Let’s say you’re computing something but you know there are some hopeless scenar...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/function-timeout-in-python-multiprocessing/"><div class="card-body"> <span class="timeago small">Feb 8, 2016<i class="unloaded">2016-02-08T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Function timeout in Python using the multiprocessing module</h3>
<div class="text-muted small"><p> The problem Sometimes you may want to impose a timeout on a Python function. Why would you want to do such a thing? Let’s say you’re computing something but you know there are some hopeless scenar...</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/fix-python-logger-printing-same-entry-multiple-times/" class="btn btn-outline-primary" prompt="Older"><p>How to fix Python logger printing the same entry multiple times</p></a> <a href="/posts/kill-subprocess-and-its-children-on-timeout-python/" class="btn btn-outline-primary" prompt="Newer"><p>Kill a Python subprocess and its children when a timeout is reached</p></a>
</div>
<div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div>
<script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://alexandra-zaharia.github.io/posts/stopping-python-systemd-service-cleanly/'; this.page.identifier = '/posts/stopping-python-systemd-service-cleanly/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://azc.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script>
</div></div></div>
<footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center">
<div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/alexandra-zaharia">Alexandra Zaharia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content">
<div id="search-hints">
<h4 class="text-muted mb-4">Trending Tags</h4>
<a class="post-tag" href="/tags/c-c/">c/c++</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/binary/">binary</a> <a class="post-tag" href="/tags/bluetooth/">bluetooth</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/mercurial/">mercurial</a> <a class="post-tag" href="/tags/thread/">thread</a> <a class="post-tag" href="/tags/version-control/">version control</a>
</div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Z7ZY7JRFQJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Z7ZY7JRFQJ'); }); </script>
